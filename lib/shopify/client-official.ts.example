/**
 * EXAMPLE: Shopify Official Package Integration
 * This shows how to use @shopify/shopify-api with Next.js
 * 
 * To use this approach:
 * 1. Run: pnpm add @shopify/shopify-api
 * 2. Rename this file to client-official.ts
 * 3. Update imports in other files
 */

import { shopifyApi, LATEST_API_VERSION, ApiVersion } from '@shopify/shopify-api';
import '@shopify/shopify-api/adapters/node';

// Initialize Shopify API client
export const shopify = shopifyApi({
  apiKey: process.env.SHOPIFY_CLIENT_ID!,
  apiSecretKey: process.env.SHOPIFY_CLIENT_SECRET!,
  scopes: ['read_products', 'read_customers', 'write_customers', 'read_orders'],
  hostName: process.env.NEXT_PUBLIC_APP_URL?.replace(/https?:\/\//, '') || 'localhost:3000',
  hostScheme: process.env.NODE_ENV === 'production' ? 'https' : 'http',
  apiVersion: LATEST_API_VERSION,
  isEmbeddedApp: false, // Set to true if building an embedded app
  isCustomStoreApp: false, // Set to true if it's a custom app for one store
});

/**
 * Create a GraphQL Admin API client for a specific shop
 */
export function createAdminApiClient(shop: string, accessToken: string) {
  const session = shopify.session.customAppSession(shop);
  session.accessToken = accessToken;

  return new shopify.clients.Graphql({ session });
}

/**
 * Create a REST Admin API client for a specific shop
 */
export function createRestApiClient(shop: string, accessToken: string) {
  const session = shopify.session.customAppSession(shop);
  session.accessToken = accessToken;

  return new shopify.clients.Rest({ session });
}

/**
 * Example: Query products using GraphQL
 */
export async function getProductsWithOfficial(shop: string, accessToken: string) {
  const client = createAdminApiClient(shop, accessToken);

  const response = await client.query({
    data: {
      query: `{
        products(first: 10) {
          edges {
            node {
              id
              title
              handle
            }
          }
        }
      }`,
    },
  });

  return response.body;
}

/**
 * Example: Create customer using GraphQL
 */
export async function createCustomerWithOfficial(
  shop: string,
  accessToken: string,
  email: string,
  tags: string[]
) {
  const client = createAdminApiClient(shop, accessToken);

  const mutation = `
    mutation customerCreate($input: CustomerInput!) {
      customerCreate(input: $input) {
        customer {
          id
          email
          tags
        }
        userErrors {
          field
          message
        }
      }
    }
  `;

  const response = await client.query({
    data: {
      query: mutation,
      variables: {
        input: {
          email,
          tags,
          acceptsMarketing: true,
          emailMarketingConsent: {
            marketingState: 'SUBSCRIBED',
            marketingOptInLevel: 'SINGLE_OPT_IN',
          },
        },
      },
    },
  });

  return response.body;
}

/**
 * Verify HMAC using official package
 */
export function verifyHmacOfficial(query: Record<string, string>): boolean {
  const { hmac, ...params } = query;
  
  if (!hmac) return false;

  return shopify.utils.validateHmac(params, hmac);
}

/**
 * Handle OAuth begin (replaces custom getAuthorizationUrl)
 */
export async function beginOAuthOfficial(shop: string) {
  return await shopify.auth.begin({
    shop: shopify.utils.sanitizeShop(shop, true)!,
    callbackPath: '/api/auth/shopify/callback',
    isOnline: false, // Use offline token (doesn't expire)
  });
}

/**
 * Handle OAuth callback (replaces custom exchangeCodeForToken)
 */
export async function handleOAuthCallbackOfficial(
  shop: string,
  code: string,
  state: string,
  storedState: string
) {
  if (state !== storedState) {
    throw new Error('State mismatch');
  }

  const callback = await shopify.auth.callback({
    rawRequest: {
      url: `https://${process.env.NEXT_PUBLIC_APP_URL}/api/auth/shopify/callback?shop=${shop}&code=${code}&state=${state}`,
    } as any,
  });

  return callback;
}

/**
 * Register webhooks
 */
export async function registerWebhooks(shop: string, accessToken: string) {
  const webhooks = [
    {
      topic: 'CUSTOMERS_CREATE',
      path: '/api/webhooks/customers-create',
    },
    {
      topic: 'ORDERS_CREATE',
      path: '/api/webhooks/orders-create',
    },
  ];

  for (const webhook of webhooks) {
    await shopify.webhooks.register({
      session: shopify.session.customAppSession(shop),
      topic: webhook.topic as any,
      path: webhook.path,
      deliveryMethod: 'http',
    });
  }
}
